<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>

    @font-face {
      font-family: WT; /* Имя шрифта */
      src: url(../fonts/wt_font.ttf); /* Путь к файлу со шрифтом */
    }

    html, body {
      padding: 0px;
      margin: 0px;
      font-family: WT;
      overflow: hidden;
      pointer-events: none;
    }

    ul.userlist, li.user {
      padding: 0px; margin:0px;
      list-style-type: none;
    }

    .userlist {
      margin-left: auto !important; 
      margin-right: auto !important;
      width: 547px;

      /*transition: transform 0.2s linear;*/
    }

    li.user { opacity: 0; }
    li.user:nth-child(1) { opacity: 0.1; }
    li.user:nth-child(2) { opacity: 0.3; }
    li.user:nth-child(3) { opacity: 0.5; }
    li.user:nth-child(4) { opacity: 0.7; }
    li.user:nth-child(5) { opacity: 0.9; }
    li.user:nth-child(6) { opacity: 1; }
    li.user:nth-child(7) { opacity: 0.9; }
    li.user:nth-child(8) { opacity: 0.8; }
    li.user:nth-child(9) { opacity: 0.7; }
    li.user:nth-child(10) { opacity: 0.6; }
    li.user:nth-child(11) { opacity: 0.5; }
    li.user:nth-child(12) { opacity: 0.4; }
    li.user:nth-child(13) { opacity: 0.3; }
    li.user:nth-child(14) { opacity: 0.2; }
    li.user:nth-child(15) { opacity: 0.1; }

    .user {
      width: 547px;
      height: 71px;
      background: url(img/username.png) no-repeat;
      text-align: center;
      line-height: 71px;
      font-size: 30px;
      color: white;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 1);
    }

    .user__selected {
      background: url(img/username_selected.png) no-repeat;
    }

    </style>

    <script>

      // browserfix
      (function() {
        var requestAnimationFrame = window.requestAnimationFrame || 
          window.mozRequestAnimationFrame ||
          window.webkitRequestAnimationFrame || 
          window.msRequestAnimationFrame;
        window.requestAnimationFrame = requestAnimationFrame;
      })();  


      var SPEED = 900, CELL_HEIGHT = 71, TIME_TO_START = 10, TIME_TO_STOP = 10;
      var minDistanceToStop = SPEED * TIME_TO_STOP / 2; // at^2/2 == (v/t)*t*t/2 == v*t/2
      var minCellsToStop = Math.ceil(minDistanceToStop / CELL_HEIGHT);

      var Wheel = function (config) {

        this.listEl = config.listElement;
        this.listEl.innerHTML = '';
        this.audioStart = config.audioStart;
        this.audioStop = config.audioStop;
        this.audioLoop1 = config.audioLoop1;
        this.audioLoop2 = config.audioLoop2;
        this.users = [];
        this.config = config;
        this.stepsDone = 0;
        this.offset = 0;
        
        var users = config.users;
        // add more users to list be filled
        var timesToRepeat = (users.length < 25) ? Math.ceil(25 / users.length) : 1;
        for (var i = 0; i < timesToRepeat; i++) {
          for (var j = 0; j < users.length; j++) {
            this.users.push(users[j]);
          }
        }

        this.repopulationFactor = timesToRepeat;
        this.initialLength = users.length;

        for (var i = 0; i < this.users.length; i++) {
          var li = document.createElement('li');
          li.appendChild(document.createTextNode(this.users[i]));
          li.classList.add('user');
          this.listEl.appendChild(li);
        };

        this.usersLength = this.users.length;

      };

      Wheel.prototype._playStart = function () {
        var me = this;
        var audioOrd = true;
        this.audioStart.play();
        this.audioLoop1.play();
        this.audioInterval = setInterval(function () {
          audioOrd = !audioOrd;
          if (audioOrd) {
            me.audioLoop1.play();
          } else {
            me.audioLoop2.play();
          }
        }, 1150);
      };

      Wheel.prototype._playStop = function () {
        var me = this;
        this.audioStop.play();
        setTimeout(function () {
          if (me.audioInterval != null) {
            clearInterval(me.audioInterval);
          }
          me.audioLoop1.pause();
          me.audioLoop2.pause();
        }, 450);
      };

      Wheel.prototype._speedStart = function(t) {
        if (t >= TIME_TO_START) return SPEED;
        return SPEED * t/TIME_TO_START;
      };

      Wheel.prototype._speedStop = function(t) {
        if (t >= TIME_TO_STOP) return 0;
        return SPEED - SPEED * t/TIME_TO_STOP;
      };

      Wheel.prototype._step = function (timestamp) {
        if (this.startTime === null) this.startTime = timestamp;
        var progress = timestamp - this.startTime;
        var dt = timestamp - this.lastTime;

        this.lastTime = timestamp;
        
        if (!this.isStopping) {
          var v = this._speedStart(progress / 1000);
          var path = v * dt / 1000;
          this.offset += path;
        } else {
          if (this.stoppingStart == null) {
            this.stoppingStart = timestamp;
          }
          var progressBeforeStop = timestamp - this.stoppingStart;
          var v = this._speedStop(progressBeforeStop / 1000);
          var path = v * dt / 1000;
          this.offset += path;

          if (v == 0) {
            this.listEl.children[5].classList.add('user__selected');
            this._playStop();
            this.stepsToReset = this.users.length - this.stepsDone % this.users.length;
            return;
          }
        }

        var stepsToDo = Math.floor((this.offset - this.stepsDone * CELL_HEIGHT) / CELL_HEIGHT);
        if (stepsToDo > 0) {
          for (var i = 0; i < stepsToDo; i++) {
            this.listEl.appendChild(this.listEl.children[0]);
          }
          this.stepsDone += stepsToDo;
          if (this.stepsDone == this.startStoppingAtOffset) {
            this.isStopping = true;
            console.log('Now stopping');
          }
        }
        this.listEl.style.webkitTransform = 'translate(0, ' + - (this.offset - this.stepsDone * CELL_HEIGHT) + 'px)';  
        
        requestAnimationFrame(this._step.bind(this));
      };

      Wheel.prototype.start = function () {
        this.reset();
        this._playStart();
        requestAnimationFrame(this._step.bind(this));
      };

      Wheel.prototype.reset = function () {
        // for (var i = 0; i < this.stepsToReset; i++) {
        //   this.listEl.appendChild(this.listEl.children[0]);
        // }
        this.stepsToReset = 0;
        this.lastTime = 0;
        this.startTime = null;
        this.startStoppingAtOffset = null;
        this.isStopping = false;
        this.stoppingStart = null;

        if (this.audioInterval != null) clearInterval(this.audioInterval);
        this.audioInterval = null;
      };

      Wheel.prototype.stopAt = function (fakeN) {

        var n = fakeN + this.initialLength * Math.floor(Math.random()*this.repopulationFactor);

        var l = this.usersLength;
        console.log('Picked ' + fakeN + ', ' + this.users[fakeN]);
        console.log('Steps done', this.stepsDone);
        console.log('Current offset', this.stepsDone % l);

        var currentOffset = this.stepsDone % l;
        var stepsToGo;
        if (currentOffset < n) {
          stepsToGo = n - currentOffset;
        } else {
          stepsToGo = l - currentOffset + n;
        }
        if (stepsToGo < minCellsToStop) {
          stepsToGo += l * Math.ceil(minCellsToStop / l);
        }
        stepsToGo -= 4; // to be at center
        this.startStoppingAtOffset = this.stepsDone + stepsToGo - minCellsToStop;

        console.log('Steps to go', stepsToGo);
        console.log('Min cells to stop', minCellsToStop);
        console.log('Start stopping at offset', this.startStoppingAtOffset);
      };

      document.addEventListener('DOMContentLoaded', function () {

        var IS_PREVIEW = false;
        if (window.self !== window.top) {
          IS_PREVIEW = true;
          document.body.classList.add('iframe');
          document.body.classList.remove('direct');
        } else {
          document.body.classList.add('direct');
          document.body.classList.remove('iframe');
        }

        var users = [];
        for (var i = 0; i < 5; i++) {
          users.push('Nagibator_' + (i+1));
        }

        var wheel = new Wheel({
          users: users,
          listElement: document.getElementById('userlist'),
          audioStart: document.getElementById('start'),
          audioStop: document.getElementById('end'),
          audioLoop1: document.getElementById('loop1'),
          audioLoop2: document.getElementById('loop2'),
          sounds: !IS_PREVIEW
        });

       
        wheel.start();
        
        setTimeout(function () {
          var n = Math.floor(Math.random() * users.length);
          wheel.stopAt(n);
        }, 10000);

        setTimeout(function () {
          wheel.start();
        }, 25000);

        setTimeout(function () {
          var n = Math.floor(Math.random() * users.length);
          wheel.stopAt(n);
        }, 35000);

      });

    </script>
  </head>
  <body>
    <ul class="userlist" id="userlist"></ul>
    <audio id="start" src="sounds/start.wav" volume="0.3"></audio>
    <audio id="loop1" src="sounds/loop.wav" volume="0.3"></audio>
    <audio id="loop2" src="sounds/loop.wav" volume="0.3"></audio>
    <audio id="end" src="sounds/end.wav" volume="0.3"></audio>
  </body>
</body>